import requests
from slack_sdk import WebClient
from slack_sdk.errors import SlackApiError
import os
from datetime import datetime, timedelta
import concurrent.futures
from functools import partial
import sys # sys ëª¨ë“ˆ ì¶”ê°€

# --- í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (GitHub Secretsì—ì„œ ê°’ì„ ê°€ì ¸ì˜´) ---
# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì „, í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
required_secrets = [
    'TABLEAU_PAT_NAME', 'TABLEAU_PAT_SECRET', 'SLACK_BOT_TOKEN', 'SLACK_CHANNEL'
]
missing_secrets = [secret for secret in required_secrets if not os.environ.get(secret)]

if missing_secrets:
    print(f"ì˜¤ë¥˜: í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: {', '.join(missing_secrets)}")
    print("GitHub ì €ì¥ì†Œì˜ Settings > Secrets and variables > Actions ì—ì„œ ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")
    sys.exit(1) # ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

TABLEAU_SERVER_URL = os.environ.get('TABLEAU_SERVER_URL', 'https://tableau.kakaocorp.com')
TABLEAU_PAT_NAME = os.environ.get('TABLEAU_PAT_NAME')
TABLEAU_PAT_SECRET = os.environ.get('TABLEAU_PAT_SECRET')
TABLEAU_SITE_ID = os.environ.get('TABLEAU_SITE_ID', 'Kakao_Mobility')
SLACK_BOT_TOKEN = os.environ.get('SLACK_BOT_TOKEN')
SLACK_CHANNEL = os.environ.get('SLACK_CHANNEL')
SLACK_TEAM_NAME = os.environ.get('SLACK_TEAM_NAME', "CX ì‹œë„ˆì§€íŒ€")


# --- ë‚ ì§œ ë° í—¤ë” ë©”ì‹œì§€ ê´€ë ¨ í•¨ìˆ˜ ---
def get_yesterday_date_ko():
    """ì–´ì œ ë‚ ì§œë¥¼ 'YYYY/MM/DD(ìš”ì¼)' í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•©ë‹ˆë‹¤."""
    yesterday = datetime.now() - timedelta(days=1)
    days_ko = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"]
    return f"{yesterday.strftime('%Y/%m/%d')}({days_ko[yesterday.weekday()]})"

def send_header_message_to_slack(client, channel_id, team_name):
    """ìŠ¬ë™ì— ë‚ ì§œì™€ íŒ€ ì •ë³´ë¥¼ í¬í•¨í•œ í—¤ë” ë©”ì‹œì§€ì™€ êµ¬ë¶„ì„ ì„ ì „ì†¡í•©ë‹ˆë‹¤."""
    yesterday_str = get_yesterday_date_ko()
    header_text_with_emoji = f"ğŸ—“ï¸ {yesterday_str}  |  ğŸ‘¥ {team_name}"
    blocks = [
        {"type": "context", "elements": [{"type": "mrkdwn", "text": header_text_with_emoji}]},
        {"type": "divider"}
    ]
    try:
        client.chat_postMessage(
            channel=channel_id,
            blocks=blocks,
            text=f"{yesterday_str} | {team_name}"
        )
    except SlackApiError as e:
        print(f"Slack API ì˜¤ë¥˜ ë°œìƒ (í—¤ë” ë©”ì‹œì§€): {e.response['error']}")
    except Exception as e:
        print(f"Slack í—¤ë” ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ì˜¤ë¥˜ ë°œìƒ: {e}")

# --- íƒœë¸”ë¡œ ì¸ì¦ ë° ëŒ€ì‹œë³´ë“œ ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜ ---
def tableau_auth(server_url, pat_name, pat_secret, site_id=''):
    """íƒœë¸”ë¡œ PATë¡œ ì¸ì¦í•˜ê³  ì„¸ì…˜ í† í°ì„ ë°˜í™˜í•©ë‹ˆë‹¤."""
    auth_url = f"{server_url}/api/3.17/auth/signin"
    headers = {'Content-Type': 'application/json', 'Accept': 'application/json'}
    payload = {
        'credentials': {
            'personalAccessTokenName': pat_name,
            'personalAccessTokenSecret': pat_secret,
            'site': {'contentUrl': site_id}
        }
    }
    try:
        print("íƒœë¸”ë¡œ ì„œë²„ì— ì¸ì¦ì„ ì‹œë„í•©ë‹ˆë‹¤...")
        response = requests.post(auth_url, json=payload, headers=headers, timeout=30)
        response.raise_for_status()
        credentials = response.json()['credentials']
        print("íƒœë¸”ë¡œ ì¸ì¦ ì„±ê³µ!")
        return credentials['token'], credentials['site']['id']
    except requests.exceptions.RequestException as req_err:
        print(f"íƒœë¸”ë¡œ ì¸ì¦ ì¤‘ ìš”ì²­ ì˜¤ë¥˜ ë°œìƒ: {req_err}")
    except Exception as e:
        print(f"íƒœë¸”ë¡œ ì¸ì¦ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ì˜¤ë¥˜ ë°œìƒ: {e}")
    return None, None

def export_dashboard(view_info, server_url, tableau_api_token, site_luid):
    """ë‹¨ì¼ ëŒ€ì‹œë³´ë“œë¥¼ ì´ë¯¸ì§€ íŒŒì¼ë¡œ ë‚´ë³´ëƒ…ë‹ˆë‹¤."""
    view_luid = view_info['luid']
    image_filename = view_info['filename']
    print(f"ë‹¤ìš´ë¡œë“œ ì‹œì‘: {image_filename}")
    export_url = f"{server_url}/api/3.17/sites/{site_luid}/views/{view_luid}/image"
    headers = {'X-Tableau-Auth': tableau_api_token, 'Accept': 'application/json'}
    params = {'resolution': 'high'}
    try:
        # GitHub Actions í™˜ê²½ì—ì„œëŠ” íŒŒì¼ì„ /tmp ë””ë ‰í„°ë¦¬ì— ì €ì¥í•˜ëŠ” ê²ƒì´ ì¢‹ìŠµë‹ˆë‹¤.
        filepath = os.path.join("/tmp", image_filename)
        response = requests.get(export_url, headers=headers, params=params, timeout=120)
        response.raise_for_status()
        with open(filepath, 'wb') as file:
            file.write(response.content)
        print(f"ë‹¤ìš´ë¡œë“œ ì„±ê³µ: {filepath}")
        return filepath
    except requests.exceptions.RequestException as req_err:
        print(f"ëŒ€ì‹œë³´ë“œ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ë·° ID: {view_luid}): {req_err}")
    return None

# --- ì´ë¯¸ì§€ ê·¸ë£¹ê³¼ ì œëª©ì„ í•¨ê»˜ ì „ì†¡í•˜ëŠ” í•¨ìˆ˜ ---
def send_image_group_to_slack(client, channel_id, downloaded_paths, group_info):
    """ë‹¤ìš´ë¡œë“œëœ ì—¬ëŸ¬ ì´ë¯¸ì§€ íŒŒì¼ì„ ì œëª©ê³¼ í•¨ê»˜ í•˜ë‚˜ì˜ ìŠ¬ë™ ë©”ì‹œì§€ë¡œ ì „ì†¡í•©ë‹ˆë‹¤."""
    if not downloaded_paths:
        group_name = group_info[0].get('title_core', 'ì•Œ ìˆ˜ ì—†ëŠ” ê·¸ë£¹')
        print(f"'{group_name}'ì— ì—…ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return False

    file_uploads = [{"file": path, "filename": os.path.basename(path)} for path in downloaded_paths]

    main_view_info = group_info[0]
    initial_comment_text = f"*{main_view_info['prefix_emoji']}* <{main_view_info['link_url']}|*{main_view_info['title_core']}*> *{main_view_info['postfix_emoji']}*"
    
    group_name_for_log = main_view_info['title_core']
    print(f"'{group_name_for_log}' ê·¸ë£¹ ì—…ë¡œë“œ ì¤€ë¹„...")

    try:
        response = client.files_upload_v2(
            channel=channel_id,
            initial_comment=initial_comment_text,
            file_uploads=file_uploads
        )
        if response.get("ok"):
            print(f"'{group_name_for_log}' ê·¸ë£¹ ì—…ë¡œë“œ ì„±ê³µ!")
            return True
        else:
            print(f"'{group_name_for_log}' ê·¸ë£¹ ì—…ë¡œë“œ ì‹¤íŒ¨: {response.get('error')}")
            return False
    except SlackApiError as e:
        print(f"Slack API ì˜¤ë¥˜ ë°œìƒ (íŒŒì¼ ê·¸ë£¹ ì—…ë¡œë“œ): {e.response['error']}")
    except Exception as e:
        print(f"Slack íŒŒì¼ ê·¸ë£¹ ì—…ë¡œë“œ ì¤‘ ì˜ˆê¸°ì¹˜ ì•Šì€ ì˜¤ë¥˜ ë°œìƒ: {e}")
    return False

# ì „ì†¡í•  ë·°ë¥¼ ê·¸ë£¹ë³„ë¡œ ì¬ì •ì˜
VIEWS_GROUP_1 = [
    {'luid': 'a3948637-c923-4b4b-b0ee-d7337903f123', 'filename': 'daily_dashboard_1_call.png', 'prefix_emoji': 'â˜ï¸', 'title_core': 'ê³ ê°ì„¼í„° ì „ì¼ ì§€í‘œ', 'postfix_emoji': 'â˜ï¸', 'link_url': 'https://tableau.kakaocorp.com/#/site/Kakao_Mobility/views/ResponseRDashboard_ver3/_?:iid=1'},
    {'luid': '7534cf1f-92b9-4f72-9bef-fd75920178bf', 'filename': 'daily_dashboard_2_chat.png'},
    {'luid': '59a9309e-7394-4b94-b686-303f220053e2', 'filename': 'daily_dashboard_3_service.png'},
]

VIEWS_GROUP_2 = [
    {'luid': '07cfa68c-6a7c-452e-bea0-975710e79e5c', 'filename': 'daily_dashboard_4_taxi.png', 'prefix_emoji': 'ğŸ†ƒ', 'title_core': 'ê³ ê°ì„¼í„° ì „ì¼ ì§€í‘œ_ì„œë¹„ìŠ¤ë³„', 'postfix_emoji': 'ğŸ†ƒ', 'link_url': 'https://tableau.kakaocorp.com/#/site/Kakao_Mobility/views/ResponseRDashboard_ver3/__3?:iid=1'},
    {'luid': '818709e6-647a-4c1a-8453-a4ffce6be063', 'filename': 'daily_dashboard_5_daeri.png'},
    {'luid': 'a01896c6-e98d-4ebc-8435-03538aab7712', 'filename': 'daily_dashboard_6_quick.png'},
    {'luid': '7842f421-d42a-4534-ba28-cd5036c34129', 'filename': 'daily_dashboard_7_parking.png'},
    {'luid': 'a8d73d6f-4ff0-4fc4-ba98-0300115fb5a5', 'filename': 'daily_dashboard_8_bike.png'},
]

# --- ê·¸ë£¹ë³„ ì²˜ë¦¬ í•¨ìˆ˜ ---
def process_and_send_group(slack_client, channel_id, view_group, group_name):
    """íƒœë¸”ë¡œ ì¸ì¦, ëŒ€ì‹œë³´ë“œ ë‹¤ìš´ë¡œë“œ, ìŠ¬ë™ ì „ì†¡ê¹Œì§€ ê·¸ë£¹ë³„ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤."""
    print(f"\n--- {group_name} ì²˜ë¦¬ ì‹œì‘ ---")
    
    # 1. íƒœë¸”ë¡œ ì¸ì¦
    tableau_session_token, actual_site_luid = tableau_auth(
        TABLEAU_SERVER_URL, TABLEAU_PAT_NAME, TABLEAU_PAT_SECRET, TABLEAU_SITE_ID
    )
    if not (tableau_session_token and actual_site_luid):
        print(f"'{group_name}'ì— ëŒ€í•œ íƒœë¸”ë¡œ ì¸ì¦ì— ì‹¤íŒ¨í•˜ì—¬ ê±´ë„ˆëœë‹ˆë‹¤.")
        return

    # 2. ëŒ€ì‹œë³´ë“œ ë³‘ë ¬ ë‹¤ìš´ë¡œë“œ
    print(f"--- {group_name} ë‹¤ìš´ë¡œë“œ ì‹œì‘ ---")
    download_task = partial(export_dashboard,
                            server_url=TABLEAU_SERVER_URL,
                            tableau_api_token=tableau_session_token,
                            site_luid=actual_site_luid)
    
    downloaded_paths = []
    with concurrent.futures.ThreadPoolExecutor(max_workers=len(view_group)) as executor:
        results = list(executor.map(download_task, view_group))
        downloaded_paths = [path for path in results if path]

    # 3. ìŠ¬ë™ì— ì´ë¯¸ì§€ ê·¸ë£¹ ì „ì†¡ ë° ë¡œì»¬ íŒŒì¼ ì‚­ì œ
    if downloaded_paths:
        send_image_group_to_slack(slack_client, channel_id, downloaded_paths, view_group)
        for path in downloaded_paths:
            try:
                os.remove(path)
                print(f"'{path}' íŒŒì¼ ì‚­ì œ ì™„ë£Œ.")
            except OSError as e:
                print(f"'{path}' íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨: {e}")
    else:
        print(f"'{group_name}'ì˜ ëª¨ë“  ëŒ€ì‹œë³´ë“œ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")


# --- ë©”ì¸ ì‘ì—… í•¨ìˆ˜ ---
def run_daily_report():
    """ë°ì¼ë¦¬ ë¦¬í¬íŠ¸ì˜ ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤."""
    print(f"\n[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âœ¨ ë°ì¼ë¦¬ ë¦¬í¬íŠ¸ ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤! âœ¨")
    slack_client = WebClient(token=SLACK_BOT_TOKEN, timeout=300)
    
    # í—¤ë” ë©”ì‹œì§€ ì „ì†¡
    send_header_message_to_slack(slack_client, SLACK_CHANNEL, team_name=SLACK_TEAM_NAME)

    # ê·¸ë£¹ 1 ì²˜ë¦¬ (ì¸ì¦ -> ë‹¤ìš´ë¡œë“œ -> ì „ì†¡)
    process_and_send_group(slack_client, SLACK_CHANNEL, VIEWS_GROUP_1, "ê·¸ë£¹ 1 (ìœ ì„ /ì±„íŒ…/ì„œë¹„ìŠ¤)")
    
    # ê·¸ë£¹ 2 ì²˜ë¦¬ë¥¼ ìœ„í•œ ì•½ê°„ì˜ ì§€ì—° ì‹œê°„ (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ì•ˆì •ì„±ì— ë„ì›€)
    time.sleep(5) 

    # ê·¸ë£¹ 2 ì²˜ë¦¬ (ì¸ì¦ -> ë‹¤ìš´ë¡œë“œ -> ì „ì†¡)
    process_and_send_group(slack_client, SLACK_CHANNEL, VIEWS_GROUP_2, "ê·¸ë£¹ 2 (íƒì‹œ/ëŒ€ë¦¬/í€µ ë“±)")

    print(f"\n--- ëª¨ë“  ì‘ì—… ì™„ë£Œ ---")
    print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ğŸ ë°ì¼ë¦¬ ë¦¬í¬íŠ¸ ì‘ì—…ì„ ë§ˆì¹©ë‹ˆë‹¤.\n")


# --- ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì§€ì  ---
if __name__ == "__main__":
    # GitHub Actionsì—ì„œ ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§ì ‘ ì‹¤í–‰í•˜ë¯€ë¡œ,
    # ì´ì „ì˜ schedule ê´€ë ¨ ì½”ë“œëŠ” ëª¨ë‘ ì œê±°í•˜ê³  run_daily_report()ë§Œ í˜¸ì¶œí•©ë‹ˆë‹¤.
    run_daily_report()
